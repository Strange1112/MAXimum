import os
import logging
import google.generativeai as genai
from dotenv import load_dotenv

load_dotenv()

API_KEY = os.getenv("GENAI_API_KEY")
if not API_KEY:
    raise ValueError("‚ùå GENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ!")

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def generate_diff_summary(old_content: str, new_content: str, topic_name: str):
    try:
        logger.info(f"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è diff –¥–ª—è —Ç–µ–º—ã: {topic_name}")
        logger.info(f"–°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è: {len(old_content)} —Å–∏–º–≤–æ–ª–æ–≤")
        logger.info(f"–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: {len(new_content)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        genai.configure(api_key=API_KEY)
        model = genai.GenerativeModel("gemini-2.5-flash")
        
        prompt = f"""
ROLE: –¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —É—á–µ–±–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö.

TASK: –°—Ä–∞–≤–Ω–∏ –¥–≤–µ –≤–µ—Ä—Å–∏–∏ –∫–æ–Ω—Å–ø–µ–∫—Ç–∞ –ø–æ —Ç–µ–º–µ "{topic_name}" –∏ —Å–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫–æ–µ —Å–∞–º–º–∞—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

–ê–ù–ê–õ–ò–ó–ò–†–£–ô:
1. –ö–∞–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –î–û–ë–ê–í–õ–ï–ù–ê (–Ω–æ–≤—ã–µ —Ä–∞–∑–¥–µ–ª—ã, —Ñ–∞–∫—Ç—ã, —Ñ–æ—Ä–º—É–ª—ã)
2. –ß—Ç–æ —Å—Ç–∞–ª–æ –ü–û–î–†–û–ë–ù–ï–ï (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è)
3. –ß—Ç–æ –ò–ó–ú–ï–ù–ò–õ–û–°–¨ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏)
4. –ß—Ç–æ –£–î–ê–õ–ï–ù–û (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø—Ä–æ–ø–∞–ª–æ)

–ü–†–ê–í–ò–õ–ê –í–´–í–û–î–ê:
- –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É
- –ì—Ä—É–ø–ø–∏—Ä—É–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ —Ç–µ–º–∞–º/—Ä–∞–∑–¥–µ–ª–∞–º
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏:
  ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ
  üìù –†–∞—Å—à–∏—Ä–µ–Ω–æ/–£—Ç–æ—á–Ω–µ–Ω–æ
  üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ
  ‚ùå –£–¥–∞–ª–µ–Ω–æ
- –§–æ—Ä–º–∞—Ç: Markdown —Å–ø–∏—Å–∫–∏
- –î–ª–∏–Ω–∞: 3-7 –ø—É–Ω–∫—Ç–æ–≤ (–Ω–µ –±–æ–ª—å—à–µ!)
- –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã ‚Äî –Ω–∞–ø–∏—à–∏ "–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏"

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
## üìä –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

‚ûï **–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª "..."
- –§–æ—Ä–º—É–ª–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ ...

üìù **–°—Ç–∞–ª–æ –ø–æ–¥—Ä–æ–±–Ω–µ–µ:**
- –†–∞—Å—à–∏—Ä–µ–Ω–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–µ–º—ã ...

---

–°–¢–ê–†–ê–Ø –í–ï–†–°–ò–Ø:
{old_content[:15000]}

–ù–û–í–ê–Ø –í–ï–†–°–ò–Ø:
{new_content[:15000]}

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–∞–º–º–∞—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
"""
        
        response = model.generate_content(prompt)
        
        if not response or not response.text:
            logger.error("Gemini –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
            return "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        
        logger.info(f"–°–∞–º–º–∞—Ä–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ, –¥–ª–∏–Ω–∞: {len(response.text)} —Å–∏–º–≤–æ–ª–æ–≤")
        return response.text
    
    except Exception as e:
        error_msg = f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ diff: {str(e)}"
        logger.error(error_msg, exc_info=True)
        return f"‚ùå {error_msg}"
